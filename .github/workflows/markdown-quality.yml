name: Markdown Quality Checks

on:
  pull_request:
    paths:
      - '**.md'
      - '.markdownlint*'
      - 'lychee.toml'
  push:
    branches:
      - main
      - 'swamy/**'
    paths:
      - '**.md'
      - '.markdownlint*'
      - 'lychee.toml'

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli2
        run: npm install -g markdownlint-cli2

      - name: Run markdownlint
        run: markdownlint-cli2 "**/*.md" --fix
        continue-on-error: true

      - name: Check for linting errors
        run: markdownlint-cli2 "**/*.md" || exit 1

  link-check:
    name: Link Checking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run lychee link checker
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress **/*.md
          fail: true

  structure-validation:
    name: Structure Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify session overview exists
        run: |
          if [ ! -f "docs/04_session-overview.md" ]; then
            echo "❌ docs/04_session-overview.md (single source of truth) is missing!"
            exit 1
          fi
          echo "✅ Session overview file exists"

      - name: Verify repository structure doc exists
        run: |
          if [ ! -f "docs/02_repository-structure.md" ]; then
            echo "❌ docs/02_repository-structure.md (single source of truth) is missing!"
            exit 1
          fi
          echo "✅ Repository structure doc exists"

      - name: Verify session overview exists
        run: |
          if [ ! -f "docs/04_session-overview.md" ]; then
            echo "❌ docs/04_session-overview.md (single source of truth) is missing!"
            exit 1
          fi
          echo "✅ Session overview doc exists"

      - name: Check session index references
        run: |
          if ! grep -q "04_session-overview.md" docs/sessions/README.md; then
            echo "⚠️  Warning: docs/sessions/README.md should reference docs/04_session-overview.md"
          fi
          echo "✅ Session index check complete"

